<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check In - Crystal City Evening Toastmasters</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f8f9fa;
            padding: 1rem;
        }
        .container { max-width: 600px; margin: 0 auto; }
        .header {
            text-align: center;
            padding: 1.5rem;
            background: #1976d2;
            color: white;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }
        .header h1 { font-size: 1.5rem; margin-bottom: 0.25rem; }
        .header p { font-size: 1rem; opacity: 0.9; }
        .card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .card h2 { margin-bottom: 1rem; color: #1976d2; font-size: 1.3rem; }
        .btn {
            display: block;
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 0.75rem;
            transition: background 0.2s;
        }
        .btn-member { background: #1976d2; color: white; }
        .btn-member:hover { background: #1565c0; }
        .btn-guest { background: #4caf50; color: white; }
        .btn-guest:hover { background: #388e3c; }
        .btn-checkin { background: #ff9800; color: white; font-size: 1.3rem; padding: 18px; }
        .btn-checkin:hover { background: #f57c00; }
        .btn-secondary { background: #e0e0e0; color: #333; }
        .btn-secondary:hover { background: #bdbdbd; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; font-weight: bold; margin-bottom: 0.25rem; }
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }
        .form-group input:focus { border-color: #1976d2; outline: none; }
        .success-message {
            text-align: center;
            padding: 2rem;
            background: #e8f5e9;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        .success-message h2 { color: #2e7d32; font-size: 1.5rem; }
        .success-message p { font-size: 1.1rem; margin-top: 0.5rem; }
        .error { color: #d32f2f; font-size: 0.9rem; margin-top: 0.5rem; }
        .attendance-list { margin-top: 1.5rem; }
        .attendance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
        }
        .attendance-item:last-child { border-bottom: none; }
        .attendance-name { font-size: 1rem; }
        .attendance-badge {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: bold;
        }
        .badge-member { background: #e3f2fd; color: #1976d2; }
        .badge-guest { background: #e8f5e9; color: #2e7d32; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Crystal City Evening Toastmasters</h1>
            <p id="meetingDateDisplay">Meeting Check-In</p>
        </div>

        <!-- Step 1: Choose member or guest -->
        <div id="stepChoose" class="card">
            <h2>How would you like to check in?</h2>
            <button class="btn btn-member" onclick="chooseMember()">üë§ I'm a Member</button>
            <button class="btn btn-guest" onclick="chooseGuest()">üëã I'm a Guest</button>
            <button class="btn btn-secondary" onclick="chooseAdmin()" style="margin-top: 0.5rem;">üîê Admin Sign In for Member or Guest</button>
        </div>

        <!-- Step 2a: Member login -->
        <div id="stepMemberLogin" class="card hidden">
            <h2>Member Login</h2>
            <div class="form-group">
                <label>Email / Username</label>
                <input type="text" id="memberEmail" placeholder="Enter your email">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="memberPassword" placeholder="Enter your password">
            </div>
            <div id="memberError" class="error hidden"></div>
            <button class="btn btn-member" onclick="memberLogin()">Log In & Check In</button>
            <button class="btn btn-secondary" onclick="goBack()">‚Üê Back</button>
        </div>

        <!-- Step 2b: Member already logged in - one tap -->
        <div id="stepMemberCheckin" class="card hidden">
            <h2>Welcome back, <span id="memberName"></span>!</h2>
            <button class="btn btn-checkin" onclick="memberCheckin()">‚úÖ I'm Here!</button>
            <button class="btn btn-secondary" onclick="goBack()">‚Üê Back</button>
        </div>

        <!-- Step 2c: Guest email lookup -->
        <div id="stepGuestEmail" class="card hidden">
            <h2>Guest Check-In</h2>
            <div class="form-group">
                <label>Email Address</label>
                <input type="email" id="guestEmail" placeholder="Enter your email">
            </div>
            <div id="guestEmailError" class="error hidden"></div>
            <button class="btn btn-guest" onclick="lookupGuest()">Next ‚Üí</button>
            <button class="btn btn-secondary" onclick="goBack()">‚Üê Back</button>
        </div>

        <!-- Step 2d: Returning guest confirmation -->
        <div id="stepGuestReturning" class="card hidden">
            <h2>Welcome back, <span id="returningGuestName"></span>!</h2>
            <button class="btn btn-checkin" onclick="guestCheckin(true)">‚úÖ I'm Here!</button>
            <button class="btn btn-secondary" onclick="goBack()">‚Üê Back</button>
        </div>

        <!-- Step 2e: New guest full form -->
        <div id="stepGuestNew" class="card hidden">
            <h2>Welcome! Please tell us about yourself</h2>
            <div class="form-group">
                <label>Name</label>
                <input type="text" id="guestName" placeholder="Your full name">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="guestEmailConfirm" readonly>
            </div>
            <div class="form-group">
                <label>Phone (optional)</label>
                <input type="tel" id="guestPhone" placeholder="Your phone number">
            </div>
            <div id="guestNewError" class="error hidden"></div>
            <button class="btn btn-checkin" onclick="guestCheckin(false)">‚úÖ Check In</button>
            <button class="btn btn-secondary" onclick="goBack()">‚Üê Back</button>
        </div>

        <!-- Step 3a: Admin login -->
        <div id="stepAdminLogin" class="card hidden">
            <h2>üîê Admin Login</h2>
            <div class="form-group">
                <label>Email / Username</label>
                <input type="text" id="adminEmail" placeholder="Admin email">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="adminPassword" placeholder="Admin password">
            </div>
            <div id="adminLoginError" class="error hidden"></div>
            <button class="btn btn-member" onclick="adminLogin()">Log In</button>
            <button class="btn btn-secondary" onclick="goBack()">‚Üê Back</button>
        </div>

        <!-- Step 3b: Admin check-in panel -->
        <div id="stepAdminPanel" class="card hidden">
            <h2>üîê Admin Check-In</h2>
            <p style="color: #666; margin-bottom: 1rem;">Check in a member or guest on their behalf.</p>
            <div class="form-group">
                <label>Type</label>
                <select id="adminCheckinType" onchange="toggleAdminForm()" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;">
                    <option value="member">Member</option>
                    <option value="guest">Guest</option>
                </select>
            </div>
            <div id="adminMemberForm">
                <div class="form-group">
                    <label>Select Member</label>
                    <select id="adminMemberSelect" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;">
                        <option value="">Loading members...</option>
                    </select>
                </div>
            </div>
            <div id="adminGuestForm" style="display: none;">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="adminCheckinName" placeholder="Full name">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="adminCheckinEmail" placeholder="Email address">
                </div>
                <div class="form-group">
                    <label>Phone (optional)</label>
                    <input type="tel" id="adminCheckinPhone" placeholder="Phone number">
                </div>
            </div>
            <div id="adminCheckinError" class="error hidden"></div>
            <button class="btn btn-checkin" onclick="adminCheckinPerson()">‚ûï Add Attendee</button>
            <hr style="margin: 1.5rem 0; border: none; border-top: 2px solid #eee;">
            <div class="form-group">
                <label>Remove Attendee</label>
                <select id="adminRemoveSelect" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;">
                    <option value="">-- Select person to remove --</option>
                </select>
            </div>
            <div id="adminRemoveError" class="error hidden"></div>
            <button class="btn btn-secondary" onclick="adminRemovePerson()" style="background: #dc3545; color: white;">‚ûñ Remove Attendee</button>
            <button class="btn btn-secondary" onclick="goBack()" style="margin-top: 0.5rem;">‚Üê Back</button>
        </div>
        <!-- Success screen -->
        <div id="stepSuccess" class="hidden">
            <div class="success-message">
                <h2>‚úÖ You're checked in!</h2>
                <p id="successName"></p>
            </div>
            <button id="addAnotherBtn" class="btn btn-member" style="display: none; max-width: 300px; margin: 1rem auto 0;" onclick="addAnotherAttendee()">‚ûï Add Another Attendee</button>
        </div>

        <!-- Attendance list (shown after check-in) -->
        <div id="attendanceSection" class="card hidden">
            <h2>üìã Attendance (<span id="attendanceCount">0</span>)</h2>
            <div id="attendanceList" class="attendance-list"></div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let meetingId = null;
        let authToken = localStorage.getItem('authToken');
        let currentUser = null;
        let checkedIn = false;

        // Get meeting ID from URL params
        const urlParams = new URLSearchParams(window.location.search);
        meetingId = urlParams.get('meeting');

        // Initialize
        async function init() {
            if (!meetingId) {
                document.querySelector('.container').innerHTML = '<div class="card"><h2>No meeting specified</h2><p>Please use the QR code at the meeting to check in.</p></div>';
                return;
            }

            // Fetch meeting info
            try {
                const res = await fetch(`${API_BASE}/meetings/index`);
                const meetings = await res.json();
                const meeting = meetings.find(m => m.id == meetingId);
                if (meeting) {
                    const date = new Date(meeting.date + 'T00:00:00');
                    document.getElementById('meetingDateDisplay').textContent =
                        date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
                }
            } catch (e) {
                console.error('Failed to load meeting info:', e);
            }

            // Check if user is already logged in
            if (authToken) {
                try {
                    const res = await fetch(`${API_BASE}/auth/verify`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ token: authToken })
                    });
                    if (res.ok) {
                        const data = await res.json();
                        currentUser = data.user || data;
                        // Check if already checked in
                        const attRes = await fetch(`${API_BASE}/attendance/index?meeting_id=${meetingId}`, {
                            headers: { 'Authorization': `Bearer ${authToken}` }
                        });
                        const attData = await attRes.json();
                        const alreadyIn = attData.attendance?.find(a => a.member_id === currentUser.id);
                        if (alreadyIn) {
                            checkedIn = true;
                            showSuccess(currentUser.name || currentUser.email);
                            loadAttendance();
                            return;
                        }
                        // Show one-tap check-in
                        document.getElementById('memberName').textContent = currentUser.name || currentUser.email;
                        hideAll();
                        document.getElementById('stepMemberCheckin').classList.remove('hidden');
                        return;
                    }
                } catch (e) {
                    console.error('Token verify failed:', e);
                }
                authToken = null;
            }

            // Show choose screen
            hideAll();
            document.getElementById('stepChoose').classList.remove('hidden');
        }

        function hideAll() {
            document.querySelectorAll('.card, #stepSuccess').forEach(el => el.classList.add('hidden'));
        }

        function goBack() {
            hideAll();
            document.getElementById('stepChoose').classList.remove('hidden');
        }

        function chooseMember() {
            hideAll();
            if (authToken && currentUser) {
                document.getElementById('memberName').textContent = currentUser.name || currentUser.email;
                document.getElementById('stepMemberCheckin').classList.remove('hidden');
            } else {
                document.getElementById('stepMemberLogin').classList.remove('hidden');
            }
        }

        function chooseGuest() {
            hideAll();
            document.getElementById('stepGuestEmail').classList.remove('hidden');
        }

        function chooseAdmin() {
            hideAll();
            // If already logged in as admin, go straight to panel
            if (authToken && currentUser && currentUser.role === 'admin') {
                document.getElementById('stepAdminPanel').classList.remove('hidden');
                loadActiveMembers();
            } else {
                document.getElementById('stepAdminLogin').classList.remove('hidden');
            }
        }

        async function adminLogin() {
            const email = document.getElementById('adminEmail').value.trim();
            const password = document.getElementById('adminPassword').value;
            const errorEl = document.getElementById('adminLoginError');
            errorEl.classList.add('hidden');

            if (!email || !password) {
                errorEl.textContent = 'Please enter email and password';
                errorEl.classList.remove('hidden');
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error);

                const user = data.user || { id: data.id, name: data.name, email: data.email, role: data.role };
                if (user.role !== 'admin') {
                    throw new Error('Admin access required');
                }

                authToken = data.token;
                currentUser = user;
                hideAll();
                document.getElementById('stepAdminPanel').classList.remove('hidden');
                loadActiveMembers();
            } catch (e) {
                errorEl.textContent = e.message || 'Login failed';
                errorEl.classList.remove('hidden');
            }
        }

        async function loadActiveMembers() {
            try {
                const res = await fetch(`${API_BASE}/members/index`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const members = await res.json();
                const select = document.getElementById('adminMemberSelect');
                select.innerHTML = '<option value="">-- Select a member --</option>';
                const active = Array.isArray(members) ? members.filter(m => m.is_active !== 0 && m.role !== 'admin') : [];
                active.sort((a, b) => a.name.localeCompare(b.name));
                active.forEach(m => {
                    select.innerHTML += `<option value="${m.email}" data-name="${m.name}">${m.name}</option>`;
                });
                // Also load attendance for remove dropdown
                await loadRemoveList();
            } catch (e) {
                console.error('Load members error:', e);
            }
        }

        function toggleAdminForm() {
            const type = document.getElementById('adminCheckinType').value;
            document.getElementById('adminMemberForm').style.display = type === 'member' ? 'block' : 'none';
            document.getElementById('adminGuestForm').style.display = type === 'guest' ? 'block' : 'none';
        }

        function addAnotherAttendee() {
            hideAll();
            document.getElementById('stepAdminPanel').classList.remove('hidden');
            document.getElementById('adminCheckinError').classList.add('hidden');
        }

        async function adminCheckinPerson() {
            const type = document.getElementById('adminCheckinType').value;
            const errorEl = document.getElementById('adminCheckinError');
            errorEl.classList.add('hidden');

            try {
                if (type === 'member') {
                    const select = document.getElementById('adminMemberSelect');
                    const email = select.value;
                    const name = select.options[select.selectedIndex]?.dataset?.name || '';
                    if (!email) {
                        errorEl.textContent = 'Please select a member';
                        errorEl.classList.remove('hidden');
                        return;
                    }
                    const res = await fetch(`${API_BASE}/attendance/index`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({ meeting_id: parseInt(meetingId), admin_member_email: email })
                    });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.error);
                    showSuccess(name);
                } else {
                    const name = document.getElementById('adminCheckinName').value.trim();
                    const email = document.getElementById('adminCheckinEmail').value.trim();
                    const phone = document.getElementById('adminCheckinPhone').value.trim();
                    if (!name || !email) {
                        errorEl.textContent = 'Name and email are required';
                        errorEl.classList.remove('hidden');
                        return;
                    }
                    const res = await fetch(`${API_BASE}/attendance/index`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            meeting_id: parseInt(meetingId),
                            guest_name: name,
                            guest_email: email,
                            guest_phone: phone || null
                        })
                    });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.error);
                    showSuccess(name);
                }
                loadAttendance();
                await loadRemoveList();
                // Clear forms
                document.getElementById('adminMemberSelect').selectedIndex = 0;
                document.getElementById('adminCheckinName').value = '';
                document.getElementById('adminCheckinEmail').value = '';
                document.getElementById('adminCheckinPhone').value = '';
            } catch (e) {
                errorEl.textContent = e.message || 'Check-in failed';
                errorEl.classList.remove('hidden');
            }
        }

        async function loadRemoveList() {
            try {
                const headers = {};
                if (authToken) headers['Authorization'] = `Bearer ${authToken}`;
                const res = await fetch(`${API_BASE}/attendance/index?meeting_id=${meetingId}`, { headers });
                const data = await res.json();
                const select = document.getElementById('adminRemoveSelect');
                select.innerHTML = '<option value="">-- Select person to remove --</option>';
                (data.attendance || []).forEach(a => {
                    const val = a.member_id ? `member_${a.member_id}` : `guest_${a.guest_id}`;
                    select.innerHTML += `<option value="${val}">${a.name} (${a.type})</option>`;
                });
            } catch (e) {
                console.error('Load remove list error:', e);
            }
        }

        async function adminRemovePerson() {
            const select = document.getElementById('adminRemoveSelect');
            const val = select.value;
            const errorEl = document.getElementById('adminRemoveError');
            errorEl.classList.add('hidden');

            if (!val) {
                errorEl.textContent = 'Please select a person to remove';
                errorEl.classList.remove('hidden');
                return;
            }

            const [type, id] = val.split('_');
            try {
                const res = await fetch(`${API_BASE}/attendance/index`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        meeting_id: parseInt(meetingId),
                        member_id: type === 'member' ? parseInt(id) : null,
                        guest_id: type === 'guest' ? parseInt(id) : null
                    })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error);
                alert(`${select.options[select.selectedIndex].text} removed.`);
                await loadRemoveList();
                loadAttendance();
            } catch (e) {
                errorEl.textContent = e.message || 'Remove failed';
                errorEl.classList.remove('hidden');
            }
        }

        async function memberLogin() {
            const email = document.getElementById('memberEmail').value.trim();
            const password = document.getElementById('memberPassword').value;
            const errorEl = document.getElementById('memberError');
            errorEl.classList.add('hidden');

            if (!email || !password) {
                errorEl.textContent = 'Please enter email and password';
                errorEl.classList.remove('hidden');
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error);

                authToken = data.token;
                localStorage.setItem('authToken', authToken);
                currentUser = data.user || { id: data.id, name: data.name, email: data.email, role: data.role };

                // Auto check-in after login
                await memberCheckin();
            } catch (e) {
                errorEl.textContent = e.message || 'Login failed';
                errorEl.classList.remove('hidden');
            }
        }

        async function memberCheckin() {
            try {
                const res = await fetch(`${API_BASE}/attendance/index`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ meeting_id: parseInt(meetingId) })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error);

                checkedIn = true;
                showSuccess(currentUser.name || currentUser.email);
                loadAttendance();
            } catch (e) {
                if (e.message === 'Already checked in') {
                    checkedIn = true;
                    showSuccess(currentUser.name || currentUser.email);
                    loadAttendance();
                } else {
                    alert('Check-in failed: ' + e.message);
                }
            }
        }

        async function lookupGuest() {
            const email = document.getElementById('guestEmail').value.trim();
            const errorEl = document.getElementById('guestEmailError');
            errorEl.classList.add('hidden');

            if (!email) {
                errorEl.textContent = 'Please enter your email';
                errorEl.classList.remove('hidden');
                return;
            }

            // Try checking in with just email to see if returning guest
            try {
                const res = await fetch(`${API_BASE}/attendance/index`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ meeting_id: parseInt(meetingId), guest_email: email })
                });
                const data = await res.json();

                if (res.ok) {
                    // Returning guest, auto checked in
                    checkedIn = true;
                    showSuccess(data.name);
                    loadAttendance();
                } else if (data.error === 'Name is required for new guests') {
                    // New guest, show full form
                    hideAll();
                    document.getElementById('guestEmailConfirm').value = email;
                    document.getElementById('stepGuestNew').classList.remove('hidden');
                } else if (data.error === 'Already checked in') {
                    checkedIn = true;
                    showSuccess(email);
                    loadAttendance();
                } else {
                    throw new Error(data.error);
                }
            } catch (e) {
                errorEl.textContent = e.message || 'Something went wrong';
                errorEl.classList.remove('hidden');
            }
        }

        async function guestCheckin(returning) {
            const email = returning ?
                document.getElementById('guestEmail').value.trim() :
                document.getElementById('guestEmailConfirm').value.trim();
            const name = returning ? null : document.getElementById('guestName').value.trim();
            const phone = returning ? null : document.getElementById('guestPhone').value.trim();

            try {
                const body = { meeting_id: parseInt(meetingId), guest_email: email };
                if (name) body.guest_name = name;
                if (phone) body.guest_phone = phone;

                const res = await fetch(`${API_BASE}/attendance/index`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error);

                checkedIn = true;
                showSuccess(data.name || name || email);
                loadAttendance();
            } catch (e) {
                const errorEl = document.getElementById('guestNewError');
                errorEl.textContent = e.message || 'Check-in failed';
                errorEl.classList.remove('hidden');
            }
        }

        function showSuccess(name) {
            hideAll();
            document.getElementById('stepSuccess').classList.remove('hidden');
            document.getElementById('successName').textContent = `Welcome, ${name}!`;
            document.getElementById('attendanceSection').classList.remove('hidden');

        // Show "Add Another" button for admins
            const addBtn = document.getElementById('addAnotherBtn');
            if (addBtn && currentUser && currentUser.role === 'admin') {
                addBtn.style.display = 'block';
            }
        }

        async function loadAttendance() {
            try {
                const headers = {};
                if (authToken) headers['Authorization'] = `Bearer ${authToken}`;

                const res = await fetch(`${API_BASE}/attendance/index?meeting_id=${meetingId}`, { headers });
                const data = await res.json();

                const list = document.getElementById('attendanceList');
                const count = document.getElementById('attendanceCount');
                count.textContent = data.attendance.length;
                
                list.innerHTML = data.attendance.map(a => `
                    <div class="attendance-item">
                        <div>
                            <span class="attendance-name">${a.name}</span>
                            <span class="attendance-badge ${a.type === 'member' ? 'badge-member' : 'badge-guest'}">${a.type}</span>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Failed to load attendance:', e);
            }
        }

        // Auto-refresh attendance every 30 seconds
        setInterval(() => {
            if (checkedIn) loadAttendance();
        }, 30000);

        // Initialize on load
        init();
    </script>
</body>
</html>
