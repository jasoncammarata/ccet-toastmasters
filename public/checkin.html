<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check In - Crystal City Evening Toastmasters</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f8f9fa;
            padding: 1rem;
        }
        .container { max-width: 600px; margin: 0 auto; }
        .header {
            text-align: center;
            padding: 1.5rem;
            background: #1976d2;
            color: white;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }
        .header h1 { font-size: 1.5rem; margin-bottom: 0.25rem; }
        .header p { font-size: 1rem; opacity: 0.9; }
        .card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .card h2 { margin-bottom: 1rem; color: #1976d2; font-size: 1.3rem; }
        .btn {
            display: block;
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 0.75rem;
            transition: background 0.2s;
        }
        .btn-member { background: #1976d2; color: white; }
        .btn-member:hover { background: #1565c0; }
        .btn-guest { background: #4caf50; color: white; }
        .btn-guest:hover { background: #388e3c; }
        .btn-checkin { background: #ff9800; color: white; font-size: 1.3rem; padding: 18px; }
        .btn-checkin:hover { background: #f57c00; }
        .btn-secondary { background: #e0e0e0; color: #333; }
        .btn-secondary:hover { background: #bdbdbd; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; font-weight: bold; margin-bottom: 0.25rem; }
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }
        .form-group input:focus { border-color: #1976d2; outline: none; }
        .success-message {
            text-align: center;
            padding: 2rem;
            background: #e8f5e9;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        .success-message h2 { color: #2e7d32; font-size: 1.5rem; }
        .success-message p { font-size: 1.1rem; margin-top: 0.5rem; }
        .error { color: #d32f2f; font-size: 0.9rem; margin-top: 0.5rem; }
        .attendance-list { margin-top: 1.5rem; }
        .attendance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
        }
        .attendance-item:last-child { border-bottom: none; }
        .attendance-name { font-size: 1rem; }
        .attendance-badge {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: bold;
        }
        .badge-member { background: #e3f2fd; color: #1976d2; }
        .badge-guest { background: #e8f5e9; color: #2e7d32; }
        .tt-checkbox { width: 20px; height: 20px; cursor: pointer; }
        .tt-label { font-size: 0.85rem; color: #666; margin-left: 0.5rem; }
        .locked-notice {
            text-align: center;
            padding: 0.75rem;
            background: #fff3cd;
            border-radius: 8px;
            color: #856404;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Crystal City Evening Toastmasters</h1>
            <p id="meetingDateDisplay">Meeting Check-In</p>
        </div>

        <!-- Step 1: Choose member or guest -->
        <div id="stepChoose" class="card">
            <h2>How would you like to check in?</h2>
            <button class="btn btn-member" onclick="chooseMember()">üë§ I'm a Member</button>
            <button class="btn btn-guest" onclick="chooseGuest()">üëã I'm a Guest</button>
        </div>

        <!-- Step 2a: Member login -->
        <div id="stepMemberLogin" class="card hidden">
            <h2>Member Login</h2>
            <div class="form-group">
                <label>Email / Username</label>
                <input type="text" id="memberEmail" placeholder="Enter your email">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="memberPassword" placeholder="Enter your password">
            </div>
            <div id="memberError" class="error hidden"></div>
            <button class="btn btn-member" onclick="memberLogin()">Log In & Check In</button>
            <button class="btn btn-secondary" onclick="goBack()">‚Üê Back</button>
        </div>

        <!-- Step 2b: Member already logged in - one tap -->
        <div id="stepMemberCheckin" class="card hidden">
            <h2>Welcome back, <span id="memberName"></span>!</h2>
            <button class="btn btn-checkin" onclick="memberCheckin()">‚úÖ I'm Here!</button>
            <button class="btn btn-secondary" onclick="goBack()">‚Üê Back</button>
        </div>

        <!-- Step 2c: Guest email lookup -->
        <div id="stepGuestEmail" class="card hidden">
            <h2>Guest Check-In</h2>
            <div class="form-group">
                <label>Email Address</label>
                <input type="email" id="guestEmail" placeholder="Enter your email">
            </div>
            <div id="guestEmailError" class="error hidden"></div>
            <button class="btn btn-guest" onclick="lookupGuest()">Next ‚Üí</button>
            <button class="btn btn-secondary" onclick="goBack()">‚Üê Back</button>
        </div>

        <!-- Step 2d: Returning guest confirmation -->
        <div id="stepGuestReturning" class="card hidden">
            <h2>Welcome back, <span id="returningGuestName"></span>!</h2>
            <button class="btn btn-checkin" onclick="guestCheckin(true)">‚úÖ I'm Here!</button>
            <button class="btn btn-secondary" onclick="goBack()">‚Üê Back</button>
        </div>

        <!-- Step 2e: New guest full form -->
        <div id="stepGuestNew" class="card hidden">
            <h2>Welcome! Please tell us about yourself</h2>
            <div class="form-group">
                <label>Name</label>
                <input type="text" id="guestName" placeholder="Your full name">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="guestEmailConfirm" readonly>
            </div>
            <div class="form-group">
                <label>Phone (optional)</label>
                <input type="tel" id="guestPhone" placeholder="Your phone number">
            </div>
            <div id="guestNewError" class="error hidden"></div>
            <button class="btn btn-checkin" onclick="guestCheckin(false)">‚úÖ Check In</button>
            <button class="btn btn-secondary" onclick="goBack()">‚Üê Back</button>
        </div>

        <!-- Success screen -->
        <div id="stepSuccess" class="hidden">
            <div class="success-message">
                <h2>‚úÖ You're checked in!</h2>
                <p id="successName"></p>
            </div>
        </div>

        <!-- Attendance list (shown after check-in) -->
        <div id="attendanceSection" class="card hidden">
            <h2>üìã Attendance (<span id="attendanceCount">0</span>)</h2>
            <div id="tableTopicsNotice"></div>
            <div id="attendanceList" class="attendance-list"></div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let meetingId = null;
        let authToken = localStorage.getItem('authToken');
        let currentUser = null;
        let isLocked = false;
        let checkedIn = false;

        // Get meeting ID from URL params
        const urlParams = new URLSearchParams(window.location.search);
        meetingId = urlParams.get('meeting');

        // Initialize
        async function init() {
            if (!meetingId) {
                document.querySelector('.container').innerHTML = '<div class="card"><h2>No meeting specified</h2><p>Please use the QR code at the meeting to check in.</p></div>';
                return;
            }

            // Fetch meeting info
            try {
                const res = await fetch(`${API_BASE}/meetings/index`);
                const meetings = await res.json();
                const meeting = meetings.find(m => m.id == meetingId);
                if (meeting) {
                    const date = new Date(meeting.date + 'T00:00:00');
                    document.getElementById('meetingDateDisplay').textContent =
                        date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
                }
            } catch (e) {
                console.error('Failed to load meeting info:', e);
            }

            // Check if user is already logged in
            if (authToken) {
                try {
                    const res = await fetch(`${API_BASE}/auth/verify`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ token: authToken })
                    });
                    if (res.ok) {
                        const data = await res.json();
                        currentUser = data.user || data;
                        // Check if already checked in
                        const attRes = await fetch(`${API_BASE}/attendance/index?meeting_id=${meetingId}`, {
                            headers: { 'Authorization': `Bearer ${authToken}` }
                        });
                        const attData = await attRes.json();
                        const alreadyIn = attData.attendance?.find(a => a.member_id === currentUser.id);
                        if (alreadyIn) {
                            checkedIn = true;
                            showSuccess(currentUser.name || currentUser.email);
                            loadAttendance();
                            return;
                        }
                        // Show one-tap check-in
                        document.getElementById('memberName').textContent = currentUser.name || currentUser.email;
                        hideAll();
                        document.getElementById('stepMemberCheckin').classList.remove('hidden');
                        return;
                    }
                } catch (e) {
                    console.error('Token verify failed:', e);
                }
                authToken = null;
            }

            // Show choose screen
            hideAll();
            document.getElementById('stepChoose').classList.remove('hidden');
        }

        function hideAll() {
            document.querySelectorAll('.card, #stepSuccess').forEach(el => el.classList.add('hidden'));
        }

        function goBack() {
            hideAll();
            document.getElementById('stepChoose').classList.remove('hidden');
        }

        function chooseMember() {
            hideAll();
            if (authToken && currentUser) {
                document.getElementById('memberName').textContent = currentUser.name || currentUser.email;
                document.getElementById('stepMemberCheckin').classList.remove('hidden');
            } else {
                document.getElementById('stepMemberLogin').classList.remove('hidden');
            }
        }

        function chooseGuest() {
            hideAll();
            document.getElementById('stepGuestEmail').classList.remove('hidden');
        }

        async function memberLogin() {
            const email = document.getElementById('memberEmail').value.trim();
            const password = document.getElementById('memberPassword').value;
            const errorEl = document.getElementById('memberError');
            errorEl.classList.add('hidden');

            if (!email || !password) {
                errorEl.textContent = 'Please enter email and password';
                errorEl.classList.remove('hidden');
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error);

                authToken = data.token;
                localStorage.setItem('authToken', authToken);
                currentUser = data.user || { id: data.id, name: data.name, email: data.email, role: data.role };

                // Auto check-in after login
                await memberCheckin();
            } catch (e) {
                errorEl.textContent = e.message || 'Login failed';
                errorEl.classList.remove('hidden');
            }
        }

        async function memberCheckin() {
            try {
                const res = await fetch(`${API_BASE}/attendance/index`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ meeting_id: parseInt(meetingId) })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error);

                checkedIn = true;
                showSuccess(currentUser.name || currentUser.email);
                loadAttendance();
            } catch (e) {
                if (e.message === 'Already checked in') {
                    checkedIn = true;
                    showSuccess(currentUser.name || currentUser.email);
                    loadAttendance();
                } else {
                    alert('Check-in failed: ' + e.message);
                }
            }
        }

        async function lookupGuest() {
            const email = document.getElementById('guestEmail').value.trim();
            const errorEl = document.getElementById('guestEmailError');
            errorEl.classList.add('hidden');

            if (!email) {
                errorEl.textContent = 'Please enter your email';
                errorEl.classList.remove('hidden');
                return;
            }

            // Try checking in with just email to see if returning guest
            try {
                const res = await fetch(`${API_BASE}/attendance/index`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ meeting_id: parseInt(meetingId), guest_email: email })
                });
                const data = await res.json();

                if (res.ok) {
                    // Returning guest, auto checked in
                    checkedIn = true;
                    showSuccess(data.name);
                    loadAttendance();
                } else if (data.error === 'Name is required for new guests') {
                    // New guest, show full form
                    hideAll();
                    document.getElementById('guestEmailConfirm').value = email;
                    document.getElementById('stepGuestNew').classList.remove('hidden');
                } else if (data.error === 'Already checked in') {
                    checkedIn = true;
                    showSuccess(email);
                    loadAttendance();
                } else {
                    throw new Error(data.error);
                }
            } catch (e) {
                errorEl.textContent = e.message || 'Something went wrong';
                errorEl.classList.remove('hidden');
            }
        }

        async function guestCheckin(returning) {
            const email = returning ?
                document.getElementById('guestEmail').value.trim() :
                document.getElementById('guestEmailConfirm').value.trim();
            const name = returning ? null : document.getElementById('guestName').value.trim();
            const phone = returning ? null : document.getElementById('guestPhone').value.trim();

            try {
                const body = { meeting_id: parseInt(meetingId), guest_email: email };
                if (name) body.guest_name = name;
                if (phone) body.guest_phone = phone;

                const res = await fetch(`${API_BASE}/attendance/index`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error);

                checkedIn = true;
                showSuccess(data.name || name || email);
                loadAttendance();
            } catch (e) {
                const errorEl = document.getElementById('guestNewError');
                errorEl.textContent = e.message || 'Check-in failed';
                errorEl.classList.remove('hidden');
            }
        }

        function showSuccess(name) {
            hideAll();
            document.getElementById('stepSuccess').classList.remove('hidden');
            document.getElementById('successName').textContent = `Welcome, ${name}!`;
            document.getElementById('attendanceSection').classList.remove('hidden');
        }

        async function loadAttendance() {
            try {
                const headers = {};
                if (authToken) headers['Authorization'] = `Bearer ${authToken}`;

                const res = await fetch(`${API_BASE}/attendance/index?meeting_id=${meetingId}`, { headers });
                const data = await res.json();
                isLocked = data.isLocked;

                const list = document.getElementById('attendanceList');
                const count = document.getElementById('attendanceCount');
                count.textContent = data.attendance.length;

                if (isLocked) {
                    document.getElementById('tableTopicsNotice').innerHTML =
                        '<div class="locked-notice">üîí Table Topics voting is locked for this meeting</div>';
                }

                list.innerHTML = data.attendance.map(a => `
                    <div class="attendance-item">
                        <div>
                            <span class="attendance-name">${a.name}</span>
                            <span class="attendance-badge ${a.type === 'member' ? 'badge-member' : 'badge-guest'}">${a.type}</span>
                        </div>
                        <div style="display: flex; align-items: center;">
                            <input type="checkbox" class="tt-checkbox"
                                ${a.is_table_topics_speaker ? 'checked' : ''}
                                ${isLocked && !(currentUser?.role === 'admin') ? 'disabled' : ''}
                                ${!checkedIn ? 'disabled' : ''}
                                onchange="toggleTableTopics(${a.member_id || 'null'}, ${a.guest_id || 'null'}, this)"
                            >
                            <span class="tt-label">TT Speaker</span>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Failed to load attendance:', e);
            }
        }

        async function toggleTableTopics(memberId, guestId, checkbox) {
            try {
                const headers = { 'Content-Type': 'application/json' };
                if (authToken) headers['Authorization'] = `Bearer ${authToken}`;

                const body = { meeting_id: parseInt(meetingId) };
                if (memberId) body.member_id = memberId;
                if (guestId) body.guest_id = guestId;

                const res = await fetch(`${API_BASE}/attendance/table-topics`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify(body)
                });
                const data = await res.json();
                if (!res.ok) {
                    checkbox.checked = !checkbox.checked;
                    alert(data.error || 'Failed to update');
                }
            } catch (e) {
                checkbox.checked = !checkbox.checked;
                alert('Failed to update: ' + e.message);
            }
        }

        // Auto-refresh attendance every 30 seconds
        setInterval(() => {
            if (checkedIn) loadAttendance();
        }, 30000);

        // Initialize on load
        init();
    </script>
</body>
</html>
